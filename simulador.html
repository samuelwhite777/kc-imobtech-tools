<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Valoriza√ß√£o Imobili√°ria</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- html2canvas for capturing HTML as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for creating PDF from image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background for 'Black Premium Platinum' */
            color: #e0e0e0; /* Light gray text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the start to optimize vertical space */
            min-height: 100vh;
            padding: 0.5rem; /* Reduced padding around the body for more space */
            box-sizing: border-box;
            /* Melhorias para renderiza√ß√£o de fonte em dispositivos Apple/macOS */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            background-color: #2a2a4a; /* Slightly lighter dark background for container */
            border-radius: 1.5rem; /* More rounded corners */
            padding: 1rem; /* Reduced padding for container */
            max-width: 700px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Reduced gap between sections */
        }
        h1 {
            color: #fdd835; /* Gold/Platinum color for headings */
            text-align: center;
            font-weight: 700;
            margin-bottom: 1rem; /* Reduced margin */
            font-size: 2.25rem; /* Adjusted base font size for mobile */
            line-height: 1.2;
        }
        @media (min-width: 640px) {
            h1 {
                font-size: 3rem; /* Adjusted font size for larger screens */
            }
        }
        h1 span.subtitle {
            display: block;
            font-size: 0.5em;
            font-weight: 500;
            color: #d1d5db;
            margin-top: 0.25rem; /* Reduced margin */
        }
        h2 { /* Style for new chart titles */
            color: #fdd835;
            text-align: center;
            font-weight: 600;
            font-size: 1.25rem; /* Adjusted for smaller screens */
            margin-top: 1.5rem; /* Reduced margin */
            margin-bottom: 0.75rem; /* Reduced margin */
        }
        @media (min-width: 640px) {
            h2 {
                font-size: 1.5rem;
            }
        }
        label {
            display: block;
            margin-bottom: 0.25rem; /* Reduced margin */
            font-weight: 500;
            color: #d1d5db;
            font-size: 0.85rem; /* Slightly smaller label font size */
        }
        @media (min-width: 640px) {
            label {
                font-size: 0.95rem;
            }
        }
        .label-with-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-icon {
            color: #fdd835; /* Gold icon color */
            cursor: pointer;
            font-size: 0.9em; /* Slightly smaller than label text */
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: #ffeb3b; /* Lighter gold on hover */
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 0.6rem; /* Slightly reduced padding */
            border: 1px solid #4a4a6e;
            border-radius: 0.75rem;
            background-color: #3a3a5e;
            color: #e0e0e0;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 0.95rem; /* Slightly smaller input font size */
            -webkit-appearance: none;
        }
        input[type="number"]:focus,
        input[type="text"]:focus {
            border-color: #fdd835;
            box-shadow: 0 0 0 2px rgba(253, 216, 53, 0.3);
        }
        input[type="number"]:disabled {
            background-color: #2a2a4a;
            color: #a0a0a0;
            cursor: not-allowed;
        }
        /* Style for the range input (slider) */
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: #4a4a6e;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #fdd835;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 0 5px rgba(253, 216, 53, 0.5);
            margin-top: -6px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #fdd835;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 0 5px rgba(253, 216, 53, 0.5);
        }

        /* Base button styles - apply to fab-button too */
        button {
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            -webkit-tap-highlight-color: transparent;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Specific color styles for buttons */
        .btn-primary { /* This style is now unused if simularBtn is removed */
            background-image: linear-gradient(to right, #fdd835, #ffeb3b);
            color: #1a1a2e;
            box-shadow: 0 4px 10px rgba(253, 216, 53, 0.4);
        }
        .btn-primary:hover:not(:disabled) {
            background-image: linear-gradient(to right, #ffeb3b, #fdd835);
        }
        .btn-whatsapp {
            background-color: #25d366;
            color: white;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4);
        }
        .btn-whatsapp:hover:not(:disabled) {
            background-color: #1da851;
        }
        .btn-whatsapp-kev-costa {
            background-color: #075E54;
            color: white;
            box-shadow: 0 4px 10px rgba(7, 94, 84, 0.4);
        }
        .btn-whatsapp-kev-costa:hover:not(:disabled) {
            background-color: #054a42;
        }
        .btn-download-charts {
            background-color: #3f51b5;
            color: white;
            box-shadow: 0 4px 10px rgba(63, 81, 181, 0.4);
        }
        .btn-download-charts:hover:not(:disabled) {
            background-color: #303f9f;
        }

        .result-panel {
            background-color: #3a3a5e;
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fdd835;
            margin-top: 1rem;
            box-shadow: inset 0 0 10px rgba(253, 216, 53, 0.3);
        }
        @media (min-width: 640px) {
            .result-panel {
                font-size: 1.25rem;
            }
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            background-color: #F0F0F0; /* Light grey background for charts */
            border-radius: 1rem;
            padding: 0.5rem;
        }
        @media (min-width: 640px) {
            .chart-container {
                height: 350px;
                padding: 1rem;
            }
        }

        /* Custom Message Box Styles */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #3a3a5e;
            color: #e0e0e0;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            text-align: center;
            max-width: 90%;
            width: 350px;
            display: none;
            border: 2px solid;
            font-size: 0.95rem;
        }
        .message-box p {
            margin-bottom: 0; /* Remove default paragraph margin */
        }
        @media (min-width: 640px) {
            .message-box {
                width: 400px;
                font-size: 1rem;
            }
        }
        .message-box.error {
            border-color: #ef4444;
        }
        .message-box.success {
            border-color: #25d366;
        }
        .message-box-close {
            background: none;
            border: none;
            color: #fdd835;
            font-size: 1.5rem;
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            cursor: pointer;
        }

        /* Floating Action Buttons Container */
        .floating-buttons-container {
            position: fixed;
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust for own height */
            right: 1rem; /* 16px from right */
            display: flex;
            flex-direction: column-reverse; /* To have 'Download' button on top */
            gap: 0.75rem; /* Space between buttons */
            z-index: 100; /* Ensure it stays on top */
            align-items: flex-end; /* Align buttons to the right */
        }
        .fab-wrapper {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Align icon and text to the right */
            transition: all 0.3s ease;
            position: relative; /* For text positioning if needed */
        }
        .fab-button {
            width: 50px; /* Fixed width for the circular button */
            height: 50px; /* Fixed height for the circular button */
            border-radius: 50%; /* Make it circular */
            padding: 0; /* Remove default padding */
            font-size: 1.25rem; /* Icon size */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent it from shrinking */
        }
        .fab-text {
            color: white; /* Text color */
            background-color: rgba(42, 42, 74, 0.9); /* Dark background for text bubble */
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            white-space: nowrap; /* Prevent text wrapping */
            opacity: 0;
            visibility: hidden;
            width: 0; /* Initially hidden */
            overflow: hidden;
            transition: all 0.3s ease;
            margin-right: -0.5rem; /* Pull text into button slightly initially */
            font-size: 0.85rem;
            font-weight: 500;
        }
        .fab-wrapper:hover .fab-text {
            opacity: 1;
            visibility: visible;
            width: auto; /* Reveal width */
            margin-right: 0.75rem; /* Space between text and button */
            margin-left: 0.5rem; /* Space between text and button */
        }
        /* Adjusted colors for FABs hover */
        .fab-button.btn-download-charts { background-color: #3f51b5; }
        .fab-button.btn-download-charts:hover { background-color: #303f9f; }
        .fab-button.btn-whatsapp { background-color: #25d366; }
        .fab-button.btn-whatsapp:hover { background-color: #1da851; }
        .fab-button.btn-whatsapp-kev-costa { background-color: #075E54; }
        .fab-button.btn-whatsapp-kev-costa:hover { background-color: #054a42; }

    </style>
</head>
<body>
    <!-- Adicionado id="container" √† div principal para que html2canvas possa captur√°-la -->
    <div class="container" id="container">
        <div class="input-section">
            <h1 class="mb-6">Simulador de Valoriza√ß√£o Imobili√°ria <span class="subtitle">por Kevillen Costa - Especialista em Mercado Imobili√°rio</span></h1>

            <div class="grid grid-cols-1 gap-4">
                <div class="form-group col-span-1">
                    <label for="valorInicialImovel">Valor Inicial do Im√≥vel (R$)</label>
                    <input type="number" id="valorInicialImovel" class="w-full" placeholder="Ex: 500000" min="1" step="0.01">
                </div>

                <div class="form-group">
                    <label for="taxaValorizacaoImovel">Taxa de Valoriza√ß√£o Anual M√©dia do Im√≥vel (<span id="taxaValorizacaoDisplay">17</span>%)</label>
                    <input type="range" id="taxaValorizacaoImovel" class="w-full" min="9" max="20" value="17">
                </div>

                <div class="form-group">
                    <label for="periodoAnalise">Per√≠odo de An√°lise (<span id="periodoAnaliseDisplay">10</span> Anos)</label>
                    <input type="range" id="periodoAnalise" class="w-full" min="4" max="20" value="10">
                </div>

                <div class="form-group">
                    <label for="taxaCDI" class="label-with-info">
                        <span>Taxa CDI (Base 2025 - %)</span>
                        <i class="fas fa-info-circle info-icon" data-justification="A Taxa DI (Certificado de Dep√≥sito Interbanc√°rio) possui uma correla√ß√£o muito forte com a Taxa Selic, sendo historicamente ligeiramente inferior (tipicamente entre 0,10 e 0,20 ponto percentual abaixo). Portanto, ao considerar uma Selic de 9,5% ao ano para o longo prazo, a Taxa DI de 9,3% ao ano √© uma estimativa consistente e pr√°tica para simula√ß√µes."></i>
                    </label>
                    <input type="number" id="taxaCDI" class="w-full" value="9.3" step="0.01">
                </div>

                <div class="form-group">
                    <label for="taxaSelic" class="label-with-info">
                        <span>Taxa Selic (Base 2025 - %)</span>
                        <i class="fas fa-info-circle info-icon" data-justification="A Selic, como taxa b√°sica de juros, tende a se estabilizar em um patamar que corresponde √† 'taxa de juros real neutra' da economia somada √† meta de infla√ß√£o de longo prazo. A taxa de juros real neutra tem estimativas medianas em torno de 5,0%. Ao somar essa taxa real neutra √† proje√ß√£o de infla√ß√£o de 4,0%, chegamos a um valor nominal de equil√≠brio de aproximadamente 9,0%. O valor de 9,5% √© um ponto m√©dio razo√°vel e alinhado com as proje√ß√µes de mercado para o longo prazo, como a de 10% para 2028."></i>
                    </label>
                    <input type="number" id="taxaSelic" class="w-full" value="9.5" step="0.01">
                </div>

                <div class="form-group">
                    <label for="taxaIPCA" class="label-with-info">
                        <span>Taxa IPCA (Base 2025 - %)</span>
                        <i class="fas fa-info-circle info-icon" data-justification="Este valor reflete a expectativa de que a infla√ß√£o brasileira convirja para o centro da meta estabelecida pelo Conselho Monet√°rio Nacional (CMN) no longo prazo. A meta atual √© de 3% com uma banda de toler√¢ncia de 1,5 ponto percentual (ou seja, teto de 4,5%). A proje√ß√£o de 4,0% considera a tend√™ncia de converg√™ncia e a realidade hist√≥rica de desafios para atingir o centro exato da meta."></i>
                    </label>
                    <input type="number" id="taxaIPCA" class="w-full" value="4.0" step="0.01">
                </div>

                <div class="form-group col-span-1">
                    <label for="whatsappCliente">WhatsApp do Cliente (Opcional)</label>
                    <input type="text" id="whatsappCliente" class="w-full" placeholder="Ex: +5547997082022 (com c√≥digo do pa√≠s e DDD)">
                </div>
            </div>
        </div>

        <div class="output-section">
            <div class="result-panel mt-6">
                Valor Final Estimado do Im√≥vel: <span id="valorFinalImovel">R$ 0,00</span>
            </div>

            <h2 class="mt-6">Valoriza√ß√£o Absoluta ao Longo do Tempo</h2>
            <div class="chart-container mt-6">
                <canvas id="absoluteValueChart"></canvas>
            </div>

            <h2 class="mt-6">Rentabilidade Percentual Acumulada</h2>
            <div class="chart-container mt-6">
                <canvas id="percentageChart"></canvas>
            </div>

            <h2 class="mt-6">Comparativo Final dos Valores</h2>
            <div class="chart-container mt-6">
                <canvas id="finalValuesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons Container -->
    <div class="floating-buttons-container">
        <div class="fab-wrapper">
            <button id="downloadPdfBtn" class="fab-button btn-download-charts" disabled>
                <i class="fas fa-file-pdf"></i>
            </button>
            <span class="fab-text">Baixar PDF da P√°gina</span>
        </div>
        <div class="fab-wrapper">
            <button id="downloadChartsBtn" class="fab-button btn-download-charts" disabled>
                <i class="fas fa-download"></i>
            </button>
            <span class="fab-text">Baixar Todos os Gr√°ficos</span>
        </div>
        <div class="fab-wrapper">
            <button id="whatsappClientBtn" class="fab-button btn-whatsapp" disabled>
                <i class="fab fa-whatsapp"></i>
            </button>
            <span class="fab-text">Enviar para WhatsApp do Cliente</span>
        </div>
        <div class="fab-wrapper">
            <button id="whatsappKevillenBtn" class="fab-button btn-whatsapp-kev-costa" disabled>
                <i class="fab fa-whatsapp"></i>
            </button>
            <span class="fab-text">Enviar para WhatsApp da Kevillen Costa</span>
        </div>
    </div>

    <!-- Custom Message Box HTML -->
    <div id="messageBox" class="message-box">
        <button class="message-box-close" onclick="hideMessage()">√ó</button>
        <p id="messageText"></p>
    </div>

    <script>
        // Refer√™ncias aos elementos do DOM
        const valorInicialImovelInput = document.getElementById('valorInicialImovel');
        const taxaValorizacaoImovelInput = document.getElementById('taxaValorizacaoImovel');
        const taxaValorizacaoDisplay = document.getElementById('taxaValorizacaoDisplay');
        const periodoAnaliseInput = document.getElementById('periodoAnalise');
        const periodoAnaliseDisplay = document.getElementById('periodoAnaliseDisplay');
        const taxaCDIInput = document.getElementById('taxaCDI');
        const taxaSelicInput = document.getElementById('taxaSelic');
        const taxaIPCAInput = document.getElementById('taxaIPCA');
        const whatsappClienteInput = document.getElementById('whatsappCliente');
        const whatsappClientBtn = document.getElementById('whatsappClientBtn');
        const whatsappKevillenBtn = document.getElementById('whatsappKevillenBtn');
        const downloadChartsBtn = document.getElementById('downloadChartsBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const valorFinalImovelSpan = document.getElementById('valorFinalImovel');

        // Chart canvas elements
        const absoluteValueChartCanvas = document.getElementById('absoluteValueChart');
        const percentageChartCanvas = document.getElementById('percentageChart');
        const finalValuesChartCanvas = document.getElementById('finalValuesChart');

        // Refer√™ncias para o Message Box
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const infoIcons = document.querySelectorAll('.info-icon');

        // Vari√°veis para os gr√°ficos
        let absoluteValueChart;
        let percentageChart;
        let finalValuesChart;

        // Fun√ß√£o para formatar n√∫meros como moeda BRL
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        };

        // Fun√ß√£o para formatar n√∫meros como porcentagem
        const formatPercentage = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value / 100);
        };

        // Fun√ß√£o para exibir mensagem personalizada (substitui alert)
        const showMessage = (message, type = 'info') => {
            messageText.textContent = message;
            messageBox.className = `message-box ${type}`; // Adiciona a classe de tipo para estiliza√ß√£o (error, success, info)
            messageBox.style.display = 'block';
        };

        // Fun√ß√£o para ocultar mensagem personalizada
        const hideMessage = () => {
            messageBox.style.display = 'none';
        };

        // Inicializa√ß√£o dos gr√°ficos
        const initCharts = () => {
            // Configura√ß√µes base para os gr√°ficos
            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#4a4a6e' // Cor da legenda
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Ano',
                            color: '#4a4a6e'
                        },
                        ticks: {
                            color: '#4a4a6e' // Cor dos ticks do eixo X
                        },
                        grid: {
                            color: 'rgba(74, 74, 110, 0.2)' // Cor das linhas de grade
                        }
                    },
                    y: {
                        ticks: {
                            color: '#4a4a6e' // Cor dos ticks do eixo Y
                        },
                        grid: {
                            color: 'rgba(74, 74, 110, 0.2)'
                        }
                    }
                }
            };

            // Gr√°fico de Valoriza√ß√£o Absoluta
            absoluteValueChart = new Chart(absoluteValueChartCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Im√≥vel',
                        data: [],
                        borderColor: '#fdd835', // Gold
                        backgroundColor: 'rgba(253, 216, 53, 0.2)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'CDI',
                        data: [],
                        borderColor: '#03a9f4', // Light Blue
                        backgroundColor: 'rgba(3, 169, 244, 0.2)',
                        tension: 0.3,
                        hidden: true // Oculto por padr√£o
                    }, {
                        label: 'Selic',
                        data: [],
                        borderColor: '#4caf50', // Green
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        tension: 0.3,
                        hidden: true // Oculto por padr√£o
                    }, {
                        label: 'IPCA',
                        data: [],
                        borderColor: '#ff9800', // Orange
                        backgroundColor: 'rgba(255, 152, 0, 0.2)',
                        tension: 0.3,
                        hidden: true // Oculto por padr√£o
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            ...commonChartOptions.scales.y,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)',
                                color: '#4a4a6e'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        },
                        legend: commonChartOptions.plugins.legend
                    }
                }
            });

            // Gr√°fico de Rentabilidade Percentual Acumulada
            percentageChart = new Chart(percentageChartCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Im√≥vel (%)',
                        data: [],
                        borderColor: '#fdd835', // Gold
                        backgroundColor: 'rgba(253, 216, 53, 0.2)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'CDI (%)',
                        data: [],
                        borderColor: '#03a9f4', // Light Blue
                        backgroundColor: 'rgba(3, 169, 244, 0.2)',
                        tension: 0.3,
                        hidden: true // Oculto por padr√£o
                    }, {
                        label: 'Selic (%)',
                        data: [],
                        borderColor: '#4caf50', // Green
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        tension: 0.3,
                        hidden: true // Oculto por padr√£o
                    }, {
                        label: 'IPCA (%)',
                        data: [],
                        borderColor: '#ff9800', // Orange
                        backgroundColor: 'rgba(255, 152, 0, 0.2)',
                        tension: 0.3,
                        hidden: true // Oculto por padr√£o
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            ...commonChartOptions.scales.y,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Rentabilidade Acumulada (%)',
                                color: '#4a4a6e'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        },
                        legend: commonChartOptions.plugins.legend
                    }
                }
            });

            // Gr√°fico Comparativo Final dos Valores
            finalValuesChart = new Chart(finalValuesChartCanvas, {
                type: 'bar',
                data: {
                    labels: ['Im√≥vel', 'CDI', 'Selic', 'IPCA'],
                    datasets: [{
                        label: 'Valor Final',
                        data: [],
                        backgroundColor: ['#fdd835', '#03a9f4', '#4caf50', '#ff9800'],
                        borderColor: ['#fdd835', '#03a9f4', '#4caf50', '#ff9800'],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        x: {
                            ...commonChartOptions.scales.x,
                            grid: {
                                display: false // Remove grid lines for bar chart X axis
                            }
                        },
                        y: {
                            ...commonChartOptions.scales.y,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor Final (R$)',
                                color: '#4a4a6e'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        },
                        legend: {
                            display: false // No legend for single dataset bar chart
                        }
                    }
                }
            });
        };

        // Fun√ß√£o principal para calcular e exibir a valoriza√ß√£o
        const calculateAppreciation = () => {
            const valorInicial = parseFloat(valorInicialImovelInput.value);
            const taxaValorizacaoImovel = parseFloat(taxaValorizacaoImovelInput.value) / 100;
            const periodo = parseInt(periodoAnaliseInput.value);
            const taxaCDI = parseFloat(taxaCDIInput.value) / 100;
            const taxaSelic = parseFloat(taxaSelicInput.value) / 100;
            const taxaIPCA = parseFloat(taxaIPCAInput.value) / 100;

            // Valida√ß√£o de inputs
            if (isNaN(valorInicial) || valorInicial <= 0) {
                showMessage('Por favor, insira um Valor Inicial do Im√≥vel v√°lido e maior que zero.', 'error');
                valorFinalImovelSpan.textContent = formatCurrency(0);
                updateCharts([], [], [], [], [], [], [], [], []); // Limpa os gr√°ficos
                whatsappClientBtn.disabled = true;
                whatsappKevillenBtn.disabled = true;
                downloadChartsBtn.disabled = true;
                downloadPdfBtn.disabled = true;
                return;
            }
            if (isNaN(taxaValorizacaoImovel) || isNaN(periodo) || isNaN(taxaCDI) || isNaN(taxaSelic) || isNaN(taxaIPCA)) {
                showMessage('Por favor, preencha todos os campos com valores num√©ricos v√°lidos.', 'error');
                valorFinalImovelSpan.textContent = formatCurrency(0);
                updateCharts([], [], [], [], [], [], [], [], []); // Limpa os gr√°ficos
                whatsappClientBtn.disabled = true;
                whatsappKevillenBtn.disabled = true;
                downloadChartsBtn.disabled = true;
                downloadPdfBtn.disabled = true;
                return;
            }

            hideMessage(); // Esconde a mensagem se a valida√ß√£o passar

            // Atualiza os displays dos sliders
            taxaValorizacaoDisplay.textContent = taxaValorizacaoImovelInput.value;
            periodoAnaliseDisplay.textContent = periodoAnaliseInput.value;

            const labels = [];
            const valoresImovel = [];
            const rentabilidadeImovel = [];
            const valoresCDI = [];
            const rentabilidadeCDI = [];
            const valoresSelic = [];
            const rentabilidadeSelic = [];
            const valoresIPCA = [];
            const rentabilidadeIPCA = [];

            let valorAtualImovel = valorInicial;
            let valorAtualCDI = valorInicial;
            let valorAtualSelic = valorInicial;
            let valorAtualIPCA = valorInicial;

            for (let i = 0; i <= periodo; i++) {
                labels.push(`Ano ${i}`);

                if (i === 0) {
                    valoresImovel.push(valorInicial);
                    rentabilidadeImovel.push(0);
                    valoresCDI.push(valorInicial);
                    rentabilidadeCDI.push(0);
                    valoresSelic.push(valorInicial);
                    rentabilidadeSelic.push(0);
                    valoresIPCA.push(valorInicial);
                    rentabilidadeIPCA.push(0);
                } else {
                    valorAtualImovel *= (1 + taxaValorizacaoImovel);
                    valoresImovel.push(valorAtualImovel);
                    rentabilidadeImovel.push(((valorAtualImovel - valorInicial) / valorInicial) * 100);

                    valorAtualCDI *= (1 + taxaCDI);
                    valoresCDI.push(valorAtualCDI);
                    rentabilidadeCDI.push(((valorAtualCDI - valorInicial) / valorInicial) * 100);

                    valorAtualSelic *= (1 + taxaSelic);
                    valoresSelic.push(valorAtualSelic);
                    rentabilidadeSelic.push(((valorAtualSelic - valorInicial) / valorInicial) * 100);

                    valorAtualIPCA *= (1 + taxaIPCA);
                    valoresIPCA.push(valorAtualIPCA);
                    rentabilidadeIPCA.push(((valorAtualIPCA - valorInicial) / valorInicial) * 100);
                }
            }

            valorFinalImovelSpan.textContent = formatCurrency(valoresImovel[periodo]);

            // Atualiza os gr√°ficos
            updateCharts(labels, valoresImovel, rentabilidadeImovel, valoresCDI, rentabilidadeCDI, valoresSelic, rentabilidadeSelic, valoresIPCA, rentabilidadeIPCA);

            // Habilita os bot√µes de download e WhatsApp
            whatsappClientBtn.disabled = !whatsappClienteInput.value.trim(); // Habilita se houver n√∫mero no campo do cliente
            whatsappKevillenBtn.disabled = false;
            downloadChartsBtn.disabled = false;
            downloadPdfBtn.disabled = false; // Habilita o bot√£o de PDF
        };

        // Fun√ß√£o para atualizar os dados dos gr√°ficos
        const updateCharts = (labels, valoresImovel, rentabilidadeImovel, valoresCDI, rentabilidadeCDI, valoresSelic, rentabilidadeSelic, valoresIPCA, rentabilidadeIPCA) => {
            // Gr√°fico de Valoriza√ß√£o Absoluta
            absoluteValueChart.data.labels = labels;
            absoluteValueChart.data.datasets[0].data = valoresImovel;
            absoluteValueChart.data.datasets[1].data = valoresCDI;
            absoluteValueChart.data.datasets[2].data = valoresSelic;
            absoluteValueChart.data.datasets[3].data = valoresIPCA;
            absoluteValueChart.update();

            // Gr√°fico de Rentabilidade Percentual Acumulada
            percentageChart.data.labels = labels;
            percentageChart.data.datasets[0].data = rentabilidadeImovel;
            percentageChart.data.datasets[1].data = rentabilidadeCDI;
            percentageChart.data.datasets[2].data = rentabilidadeSelic;
            percentageChart.data.datasets[3].data = rentabilidadeIPCA;
            percentageChart.update();

            // Gr√°fico Comparativo Final dos Valores
            finalValuesChart.data.datasets[0].data = [
                valoresImovel[valoresImovel.length - 1],
                valoresCDI[valoresCDI.length - 1],
                valoresSelic[valoresSelic.length - 1],
                valoresIPCA[valoresIPCA.length - 1]
            ];
            finalValuesChart.update();
        };

        // Event listeners para os inputs para recalcular dinamicamente
        valorInicialImovelInput.addEventListener('input', calculateAppreciation);
        taxaValorizacaoImovelInput.addEventListener('input', calculateAppreciation);
        periodoAnaliseInput.addEventListener('input', calculateAppreciation);
        taxaCDIInput.addEventListener('input', calculateAppreciation);
        taxaSelicInput.addEventListener('input', calculateAppreciation);
        taxaIPCAInput.addEventListener('input', calculateAppreciation);
        whatsappClienteInput.addEventListener('input', () => {
            whatsappClientBtn.disabled = !whatsappClienteInput.value.trim();
        });

        // Event listeners para os √≠cones de informa√ß√£o
        infoIcons.forEach(icon => {
            icon.addEventListener('click', (event) => {
                const justification = event.target.dataset.justification;
                showMessage(justification, 'info');
            });
        });

        // Fun√ß√£o para enviar mensagem via WhatsApp
        const sendWhatsAppMessage = (phoneNumber, forKevillen = false) => {
            const valorInicial = parseFloat(valorInicialImovelInput.value);
            const taxaValorizacaoImovel = parseFloat(taxaValorizacaoImovelInput.value);
            const periodo = parseInt(periodoAnaliseInput.value);
            const taxaCDI = parseFloat(taxaCDIInput.value);
            const taxaSelic = parseFloat(taxaSelicInput.value);
            const taxaIPCA = parseFloat(taxaIPCAInput.value);
            const valorFinalImovel = parseFloat(valorFinalImovelSpan.textContent.replace('R$', '').replace(/\./g, '').replace(',', '.'));

            let message = `Ol√°! üè° Simula√ß√£o de Valoriza√ß√£o Imobili√°ria:\n\n`;
            message += `*Dados da Simula√ß√£o:*\n`;
            message += `  - Valor Inicial do Im√≥vel: ${formatCurrency(valorInicial)}\n`;
            message += `  - Taxa de Valoriza√ß√£o Anual do Im√≥vel: ${taxaValorizacaoImovel}%\n`;
            message += `  - Per√≠odo de An√°lise: ${periodo} anos\n`;
            message += `  - Taxa CDI: ${taxaCDI}%\n`;
            message += `  - Taxa Selic: ${taxaSelic}%\n`;
            message += `  - Taxa IPCA: ${taxaIPCA}%\n\n`;
            message += `*Resultados:*\n`;
            message += `  - *Valor Final Estimado do Im√≥vel:* ${formatCurrency(valorFinalImovel)}\n\n`;

            if (forKevillen) {
                message += `*Mensagem enviada de Kevillen Costa - Especialista em Mercado Imobili√°rio.*`;
                phoneNumber = '5547997082022'; // N√∫mero fixo da Kevillen Costa
            } else if (!phoneNumber) {
                showMessage('Por favor, insira o n√∫mero de WhatsApp do cliente ou utilize o bot√£o para enviar para a Kevillen.', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        };

        // Event listener para o bot√£o de WhatsApp do Cliente
        whatsappClientBtn.addEventListener('click', () => {
            const phoneNumber = whatsappClienteInput.value.replace(/[^0-9+]/g, ''); // Remove caracteres n√£o num√©ricos, mantendo o '+'
            sendWhatsAppMessage(phoneNumber);
        });

        // Event listener para o bot√£o de WhatsApp da Kevillen Costa
        whatsappKevillenBtn.addEventListener('click', () => {
            sendWhatsAppMessage('', true); // Envia para o n√∫mero fixo da Kevillen
        });

        // Fun√ß√£o para baixar os gr√°ficos
        const downloadCharts = () => {
            const chartsToDownload = [
                { canvas: absoluteValueChartCanvas, name: 'valorizacao_absoluta' },
                { canvas: percentageChartCanvas, name: 'rentabilidade_percentual' },
                { canvas: finalValuesChartCanvas, name: 'comparativo_final' }
            ];

            chartsToDownload.forEach(chartInfo => {
                const link = document.createElement('a');
                link.download = `${chartInfo.name}.png`;
                link.href = chartInfo.canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            showMessage('Gr√°ficos baixados com sucesso!', 'success');
        };

        // Event listener para o bot√£o de download dos gr√°ficos
        downloadChartsBtn.addEventListener('click', downloadCharts);

        // Fun√ß√£o para baixar a p√°gina como PDF
        const downloadPdf = async () => {
            const container = document.getElementById('container'); // Elemento principal a ser capturado
            if (!container) {
                showMessage('Erro: Elemento principal do simulador n√£o encontrado para gerar o PDF.', 'error');
                console.error('Element with ID "container" not found.');
                return;
            }

            showMessage('Gerando PDF... Isso pode levar alguns segundos. Por favor, n√£o interaja com a p√°gina.', 'info');

            // Salva os estilos originais para restaur√°-los depois
            const originalBodyOverflow = document.body.style.overflow;
            const originalHtmlOverflow = document.documentElement.style.overflow;
            const originalBodyMinHeight = document.body.style.minHeight;

            // Define um estilo tempor√°rio para o body e html para garantir que todo o conte√∫do seja renderizado pelo html2canvas
            document.body.style.overflow = 'visible';
            document.documentElement.style.overflow = 'visible';
            document.body.style.minHeight = 'auto'; // Garante que o body se expanda para todo o conte√∫do

            // Oculta os bot√µes flutuantes e a caixa de mensagem durante a captura
            const floatingButtons = document.querySelector('.floating-buttons-container');
            const messageBoxElement = document.getElementById('messageBox');

            if (floatingButtons) floatingButtons.style.display = 'none';
            // Garante que a caixa de mensagem esteja oculta para n√£o aparecer no PDF
            if (messageBoxElement) messageBoxElement.style.display = 'none'; 

            try {
                // Pequeno atraso para garantir que a renderiza√ß√£o esteja completa
                await new Promise(resolve => setTimeout(resolve, 100)); 

                // Captura o conte√∫do do container para um canvas
                const canvas = await html2canvas(container, { 
                    scale: 2, // Maior escala para melhor resolu√ß√£o no PDF
                    useCORS: true, // Importante para imagens ou recursos externos (gr√°ficos Chart.js)
                    backgroundColor: '#2a2a4a', // Define a cor de fundo do container no PDF
                    logging: true, // Habilita logs no console para depura√ß√£o
                });

                console.log('Canvas dimensions:', canvas.width, 'x', canvas.height); // Log para depura√ß√£o

                const imgData = canvas.toDataURL('image/png'); // Converte o canvas para imagem PNG
                const { jsPDF } = window.jspdf; // Obt√©m a inst√¢ncia do jsPDF
                const pdf = new jsPDF('p', 'mm', 'a4'); // Inicializa PDF A4 em retrato

                const pdfWidth = pdf.internal.pageSize.getWidth(); // Largura da p√°gina A4 em mm
                const pdfHeight = pdf.internal.pageSize.getHeight(); // Altura da p√°gina A4 em mm

                const imgOriginalWidth = canvas.width;
                const imgOriginalHeight = canvas.height;

                // Calcula as dimens√µes da imagem para caber na largura do PDF mantendo a propor√ß√£o
                let imgRenderWidth = pdfWidth;
                let imgRenderHeight = (imgOriginalHeight * pdfWidth) / imgOriginalWidth;

                let heightRemaining = imgRenderHeight;
                let yOffset = 0; // Offset Y para a imagem no PDF

                // Adiciona p√°ginas at√© que todo o conte√∫do seja renderizado
                while (heightRemaining > 0) {
                    pdf.addImage(imgData, 'PNG', 0, yOffset, imgRenderWidth, imgRenderHeight);
                    heightRemaining -= pdfHeight;
                    yOffset -= pdfHeight; // Move a imagem para cima para a pr√≥xima p√°gina
                    if (heightRemaining > 0) {
                        pdf.addPage();
                    }
                }

                pdf.save('simulacao_imobiliaria.pdf'); // Salva o arquivo PDF
                showMessage('PDF da p√°gina baixado com sucesso!', 'success');

            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showMessage('Ocorreu um erro ao gerar o PDF. Detalhes: ' + error.message + '. Verifique o console para mais informa√ß√µes.', 'error');
            } finally {
                // Restaura os estilos originais do body e html
                document.body.style.overflow = originalBodyOverflow;
                document.documentElement.style.overflow = originalHtmlOverflow;
                document.body.style.minHeight = originalBodyMinHeight;

                // Restaura a visibilidade dos bot√µes flutuantes
                if (floatingButtons) floatingButtons.style.display = 'flex';
                // Garante que a caixa de mensagem esteja oculta ap√≥s a opera√ß√£o
                hideMessage(); 
            }
        };

        // Event listener para o novo bot√£o de download de PDF
        downloadPdfBtn.addEventListener('click', downloadPdf);


        // Chamar a fun√ß√£o de inicializa√ß√£o dos gr√°ficos e o c√°lculo inicial ao carregar a p√°gina
        window.onload = () => {
            initCharts();
            calculateAppreciation(); // Realiza um c√°lculo inicial com os valores padr√£o
        };
    </script>
</body>
</html>

