<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Proposta de Pagamento | Kevillen Costa</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'custom-bg-dark': '#0A0A0A',
                    }
                }
            }
        }
    </script>
    <!-- React & ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
            cursor: grab;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4a4a4a;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
            @apply shadow-inner; /* Add inner shadow for depth */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3B82F6; /* Blue-600 */
            border-radius: 50%;
            cursor: grab;
            transition: background .2s, transform .2s;
            @apply shadow-md; /* Add shadow to thumb */
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2563EB; /* Blue-700 */
            transform: scale(1.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3B82F6; /* Blue-600 */
            border-radius: 50%;
            cursor: grab;
            transition: background .2s, transform .2s;
            @apply shadow-md;
        }
        input[type="range"]::-moz-range-thumb:hover {
            background: #2563EB; /* Blue-700 */
            transform: scale(1.1);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Custom styles for collapsible insights */
        .insight-box {
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #3b82f6; /* Blue-600 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.5rem;
            color: #d1d5db; /* Gray-300 */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-5 */
        }
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: #93c5fd; /* Blue-300 */
        }
        .insight-content {
            padding-top: 0.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .insight-content.open {
            max-height: 200px; /* Adjust as needed for content length */
            transition: max-height 0.5s ease-in;
        }
        .insight-arrow {
            transition: transform 0.3s ease;
        }
        .insight-arrow.open {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-custom-bg-dark text-gray-100 font-sans min-h-screen flex flex-col justify-center items-center py-8 px-4 sm:px-6 lg:px-8">

    <div id="root" class="w-full max-w-4xl"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const { createRoot } = ReactDOM;

        // Utility function to convert to number, treating invalid inputs as 0
        const parseToNumber = (value) => {
            const num = parseFloat(String(value).replace(',', '.')); // Handle comma as decimal separator
            return isNaN(num) ? 0 : num;
        };

        // Utility function to format currency values in BRL
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        };

        // Custom Slider Component
        const CustomSlider = ({ label, value, onChange, min, max, step, displayValue, unit = '', children }) => {
            const display = displayValue !== undefined ? displayValue : value;
            return (
                <div className="mb-6">
                    <label className="block text-gray-300 text-sm font-semibold mb-2">
                        {label}: <span className="text-blue-400 font-bold">{display}{unit}</span>
                    </label>
                    <input
                        type="range"
                        min={min}
                        max={max}
                        step={step}
                        value={value}
                        onChange={onChange}
                        className="w-full"
                    />
                    {children} {/* Render children (AI insights) below the slider */}
                </div>
            );
        };

        // Info Card Component for Results
        const InfoCard = ({ label, value, type = 'blue' }) => {
            const bgColor = type === 'blue' ? 'bg-blue-900/20 border-blue-600' : 'bg-amber-900/20 border-amber-600';
            const textColor = type === 'blue' ? 'text-blue-300' : 'text-amber-300';
            return (
                <div className={`p-4 rounded-lg border ${bgColor} shadow-md`}>
                    <p className="text-sm text-gray-400">{label}</p>
                    <p className={`text-xl font-bold ${textColor}`}>{value}</p>
                </div>
            );
        };

        // AI Insight Box Component
        const AISuggestionBox = ({ insight, idealValue, onApply }) => {
            const [isOpen, setIsOpen] = useState(false);

            if (!insight) return null;

            return (
                <div className="insight-box">
                    <div className="insight-header" onClick={() => setIsOpen(!isOpen)}>
                        <span>Sugestão de IA</span>
                        <span className={`insight-arrow ${isOpen ? 'open' : ''}`}>&#9658;</span> {/* Unicode right arrow */}
                    </div>
                    <div className={`insight-content ${isOpen ? 'open' : ''}`}>
                        <p>{insight}</p>
                        {idealValue !== undefined && idealValue !== null && (
                            <div className="mt-2">
                                <span className="font-semibold text-blue-400">Valor Ideal: </span>
                                <span className="text-blue-200">
                                    {typeof idealValue === 'number' && label.includes('R$') ? formatCurrency(idealValue) : idealValue}
                                    {typeof idealValue === 'number' && label.includes('Meses') ? ` ${idealValue} meses` : ''}
                                    {typeof idealValue === 'number' && label.includes('Entrada') ? ` ${idealValue}%` : ''}
                                </span>
                                <button
                                    onClick={() => onApply(idealValue)}
                                    className="ml-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-md transition-colors duration-200"
                                >
                                    Aplicar
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main Proposal Generator Component
        const App = () => {
            // States for input parameters
            const [valorImovel, setValorImovel] = useState(500000);
            const [entradaPercentual, setEntradaPercentual] = useState(10); // Default to 10% as requested
            const [mesesObra, setMesesObra] = useState(24);
            const [valorReforcoAnual, setValorReforcoAnual] = useState(15000);
            const [numeroTotalReforcosAnuais, setNumeroTotalReforcosAnuais] = useState(2);
            const [mesesTotaisFluxo, setMesesTotaisFluxo] = useState(120); // Default to 120 months, Max 140
            const [valorNasChaves, setValorNasChaves] = useState(0);

            // States for calculated results
            const [parcelasObraMensal, setParcelasObraMensal] = useState(0);
            const [totalPagoObra, setTotalPagoObra] = useState(0);
            const [mesesFinanciamentoPosObra, setMesesFinanciamentoPosObra] = useState(0);
            const [parcelaMensalPosObra, setParcelaMensalPosObra] = useState(0);
            const [saldoTotalFinanciarPosObra, setSaldoTotalFinanciarPosObra] = useState(0);
            const [reforcosAplicadosNaObra, setReforcosAplicadosNaObra] = useState(0);

            // States for feedback messages to the user
            const [warningObra, setWarningObra] = useState('');
            const [warningPosObra, setWarningPosObra] = useState('');
            const [isGeneratingSuggestions, setIsGeneratingSuggestions] = useState(false);
            const [aiSuggestions, setAiSuggestions] = useState({}); // Stores AI suggestions for each parameter

            // Constants for financial rules
            const MIN_PARCELA_MENSAL = 2000;
            const TARGET_PERCENT_PAID_DURING_CONSTRUCTION = 0.50; // 50% of property value must be paid during construction
            const HIGH_PARCELA_THRESHOLD = 5000; // Threshold for "high" installment, triggers a warning

            // Main calculation function
            const calculateProposal = useCallback(() => {
                const valImovel = parseToNumber(valorImovel);
                const entPerc = parseToNumber(entradaPercentual);
                const mesObra = parseToNumber(mesesObra);
                const valReforcoAnual = parseToNumber(valorReforcoAnual);
                const numTotalReforcosAnuaisCalculado = parseToNumber(numeroTotalReforcosAnuais);
                const mesTotaisFluxo = parseToNumber(mesesTotaisFluxo);
                const valChaves = parseToNumber(valorNasChaves);

                // Reset warnings
                setWarningObra('');
                setWarningPosObra('');

                // Avoid calculations with zero property value to prevent NaN/Infinity
                if (valImovel === 0) {
                    setParcelasObraMensal(0);
                    setTotalPagoObra(0);
                    setMesesFinanciamentoPosObra(0);
                    setParcelaMensalPosObra(0);
                    setSaldoTotalFinanciarPosObra(0);
                    setReforcosAplicadosNaObra(0);
                    return;
                }

                // 1. Calculate Initial Payment
                const valorEntrada = (valImovel * entPerc) / 100;

                // 2. Calculate Annual Reinforcements during Construction
                // Determines how many annual reinforcements fall within the construction period (full years only)
                const reforcosDuranteObraCount = Math.min(numTotalReforcosAnuaisCalculado, Math.floor(mesObra / 12));
                const totalReforcosQueCaemNaObra = reforcosDuranteObraCount * valReforcoAnual;
                setReforcosAplicadosNaObra(reforcosDuranteObraCount);

                // 3. Calculate Monthly Installments During Construction
                // Value that *should* be paid during construction (50% of the property) to meet the rule
                const target50PercentInConstruction = valImovel * TARGET_PERCENT_PAID_DURING_CONSTRUCTION;
                
                // Amount already paid by initial payment and reinforcements *that fall within construction period*
                const valorPagoPorEntradaEReforcosNaObra = valorEntrada + totalReforcosQueCaemNaObra;

                let parcelasMensaisObraCalculado = 0;
                let valorTotalDasParcelasObra = 0; // The total sum of all monthly installments during construction

                if (mesObra > 0) {
                    if (valorPagoPorEntradaEReforcosNaObra >= target50PercentInConstruction) {
                        // If entry + reinforcements already meet or exceed the 50% target,
                        // no further monthly installments are needed for the 50% target.
                        parcelasMensaisObraCalculado = 0;
                    } else {
                        // If entry + reinforcements don't meet the 50% target,
                        // calculate monthly installments to cover the remaining difference to hit the 50% target.
                        const valorFaltandoParaParcelasObra = target50PercentInConstruction - valorPagoPorEntradaEReforcosNaObra;
                        const parcelasMensaisObraCalculadoRaw = valorFaltandoParaParcelasObra / mesObra;

                        // Apply the minimum monthly installment of R$ 2,000
                        parcelasMensaisObraCalculado = Math.max(MIN_PARCELA_MENSAL, parcelasMensaisObraCalculadoRaw);

                        // Provide feedback if the raw calculated installment was adjusted up or is high
                        if (parcelasMensaisObraCalculadoRaw > 0 && parcelasMensaisObraCalculadoRaw < MIN_PARCELA_MENSAL) {
                            setWarningObra(`A parcela mensal durante a obra foi ajustada para o mínimo de ${formatCurrency(MIN_PARCELA_MENSAL)}.`);
                        } else if (parcelasMensaisObraCalculadoRaw > HIGH_PARCELA_THRESHOLD) {
                             setWarningObra(`A parcela mensal durante a obra (${formatCurrency(parcelasMensaisObraCalculadoRaw)}) está alta. Considere aumentar a entrada ou os reforços anuais para reduzir.`);
                        }
                    }
                    valorTotalDasParcelasObra = parcelasMensaisObraCalculado * mesObra;

                } else { // mesObra === 0 (No construction months, so no construction installments)
                    parcelasMensaisObraCalculado = 0;
                    valorTotalDasParcelasObra = 0;
                }

                setParcelasObraMensal(parcelasMensaisObraCalculado);

                // 4. Calculate Total Paid During Construction
                // This is the actual sum of initial payment, reinforcements *that fell during construction*, and *actual monthly installments paid*.
                // Note: if (valorPagoPorEntradaEReforcosNaObra >= target50PercentInConstruction), then totalPaidDuringConstruction will be valorPagoPorEntradaEReforcosNaObra.
                // Otherwise, it will be target50PercentInConstruction + any surplus from min installment adjustment.
                let actualTotalPaidDuringConstruction = valorEntrada + totalReforcosQueCaemNaObra + valorTotalDasParcelasObra;
                
                // If actualTotalPaidDuringConstruction is less than 50% due to mesObra = 0 or specific scenarios,
                // and if the 50% target was not reached by entry/reinforcements, ensure it's at least 50% if possible by monthly installments.
                // This handles cases where parcelasMensaisObraCalculado became 0 due to 0 mesObra, but target wasn't met.
                if (mesObra > 0 && valorPagoPorEntradaEReforcosNaObra < target50PercentInConstruction) {
                    actualTotalPaidDuringConstruction = target50PercentInConstruction + Math.max(0, valorTotalDasParcelasObra - (target50PercentInConstruction - valorPagoPorEntradaEReforcosNaObra));
                }

                setTotalPagoObra(actualTotalPaidDuringConstruction);

                // 5. Calculate Total Reinforcements Over the Entire Flux (all years)
                // This value impacts the total amount to be financed after all other contributions.
                const totalValorTodosReforcos = numTotalReforcosAnuaisCalculado * valReforcoAnual;

                // 6. Calculate Remaining Balance to be Financed Post-Construction
                // This balance is the total property value minus initial payment, *ALL* annual reinforcements,
                // total monthly installments during construction, and the value paid on keys.
                // IMPORTANT: The sum of `valorEntrada` + `totalValorTodosReforcos` + `valorTotalDasParcelasObra` + `valChaves` represents the total amount paid by the client
                // across all phases. This sum reduces the `valorImovel` to determine the `saldoTotalFinanciarPosObra`.
                let saldoTotalFinanciar = valImovel - (valorEntrada + totalValorTodosReforcos + valorTotalDasParcelasObra + valChaves);
                
                if (saldoTotalFinanciar < 0) saldoTotalFinanciar = 0; // Ensures the balance is not negative
                setSaldoTotalFinanciarPosObra(saldoTotalFinanciar);

                // 7. Months of Post-Construction Financing
                const mesesFinancPosObra = Math.max(0, mesTotaisFluxo - mesObra);
                setMesesFinanciamentoPosObra(mesesFinancPosObra);

                // 8. Monthly Installment Value Post-Construction
                let parcelaMensalPosObraCalculado = 0;
                if (mesesFinancPosObra > 0) {
                    const parcelaMensalPosObraCalculadoRaw = saldoTotalFinanciar / mesesFinancPosObra;
                    
                    // Apply the minimum monthly installment of R$ 2,000
                    parcelaMensalPosObraCalculado = Math.max(MIN_PARCELA_MENSAL, parcelaMensalPosObraCalculadoRaw);
                    
                    // Provide feedback if the raw calculated installment was adjusted up or is high
                    if (parcelaMensalPosObraCalculadoRaw > 0 && parcelaMensalPosObraCalculadoRaw < MIN_PARCELA_MENSAL) {
                        setWarningPosObra(`A parcela mensal pós-obra foi ajustada para o mínimo de ${formatCurrency(MIN_PARCELA_MENSAL)}.`);
                    } else if (parcelaMensalPosObraCalculadoRaw > HIGH_PARCELA_THRESHOLD) {
                        setWarningPosObra(`A parcela mensal pós-obra (${formatCurrency(parcelaMensalPosObraCalculadoRaw)}) está alta. Considere aumentar a entrada, os reforços anuais ou o valor nas chaves para reduzir o saldo a financiar.`);
                    }
                }
                setParcelaMensalPosObra(parcelaMensalPosObraCalculado);

            }, [valorImovel, entradaPercentual, mesesObra, valorReforcoAnual, numeroTotalReforcosAnuais, mesesTotaisFluxo, valorNasChaves]); // Dependencies of the calculateProposal function

            // Call the calculation function whenever an input state changes
            useEffect(() => {
                calculateProposal();
            }, [calculateProposal]);


            // Function to send data via WhatsApp
     